<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="pers.zc.activiti.mapper.ProcessMapper">
    <select id="doingTasks" parameterType="Map" resultType="Map">
    SELECT * from act_ge_bytearray LIMIT 1
    </select>
    <!--查询待办-->
    <select id="getDoingTasks"
            parameterType="pers.zc.activiti.viewmodels.PagedFilterViewModel"
            resultType="pers.zc.activiti.model.viewmodels.TaskViewModel">
        SELECT
        task.ID_ AS id,
        task.PROC_INST_ID_ as processId,
        task.NAME_ AS name,
        task.CREATE_TIME_ AS createTime,
        fd.name AS processName,
        task.ASSIGNEE_ AS started,
        inst.START_TIME_ AS startedTime,
        flow_version.titleHtml,
        node.formId AS formId,
        flow_definition.icon,
        flow_definition.listIcon AS listIcon
        FROM ACT_RU_TASK AS task
        LEFT JOIN ACT_HI_PROCINST AS inst ON task.PROC_INST_ID_ = inst.ID_
        LEFT JOIN flow_version AS fv ON SUBSTRING_INDEX(task.PROC_DEF_ID_, ':', 1 ) = fv.id
        LEFT JOIN flow_definition AS fd ON fd.id = fv.definitionId
        LEFT JOIN flow_version ON flow_version.id = SUBSTRING_INDEX(inst.PROC_DEF_ID_, ':', 1 )
        LEFT JOIN flow_node node ON flow_version.id = node.processId AND flow_version.startedNodeId = node.id
        LEFT JOIN flow_definition ON flow_definition.id = flow_version.definitionId
        WHERE (flow_definition.isTest = 0 OR flow_definition.isTest IS NULL) AND
        (task.ASSIGNEE_ = #{filters.currentUserId} OR
        (task.ASSIGNEE_ = 'initiator' AND task.TASK_DEF_KEY_ IN (
        SELECT node_id FROM flow_node_executor AS exe
        WHERE (exe.executor_type = '全部') OR
        (exe.executor_type = '用户' AND exe.executor_id = #{filters.currentUserId}) OR
        (exe.executor_type = '发起人' AND #{filters.currentUserId} IN (SELECT START_USER_ID_ FROM ACT_HI_PROCINST WHERE
        ACT_HI_PROCINST.PROC_INST_ID_ = task.PROC_INST_ID_ ))
        )))
        <if test="filters.processName != null">
            AND fd.name LIKE '%${filters.processName}%'
        </if>
        <if test="filters.nodeName != null">
            AND task.NAME_ LIKE '%${filters.nodeName}%'
        </if>
        ORDER BY task.PRIORITY_ DESC, task.CREATE_TIME_ DESC
        LIMIT #{start}, #{size}
    </select>
    <select id="getDoingTasksCount"
            parameterType="pers.zc.activiti.viewmodels.PagedFilterViewModel"
            resultType="Long">
        SELECT COUNT(*) FROM ACT_RU_TASK AS task
        LEFT JOIN ACT_HI_PROCINST AS inst ON task.PROC_INST_ID_ = inst.ID_
        LEFT JOIN ACT_RE_PROCDEF AS proc ON task.PROC_DEF_ID_ = proc.ID_
        LEFT JOIN flow_version ON flow_version.id = SUBSTRING_INDEX(inst.PROC_DEF_ID_, ':', 1 )
        LEFT JOIN flow_definition ON flow_definition.id = flow_version.definitionId
        WHERE (flow_definition.isTest = 0 OR flow_definition.isTest IS NULL) AND
        (task.ASSIGNEE_ = #{filters.currentUserId} OR
        (task.ASSIGNEE_ = 'initiator' AND task.TASK_DEF_KEY_ IN (
        SELECT node_id FROM flow_node_executor AS exe
        WHERE (exe.executor_type = '全部') OR
        (exe.executor_type = '用户' AND exe.executor_id = #{filters.currentUserId}) OR
        (exe.executor_type = '发起人' AND #{filters.currentUserId} IN (SELECT START_USER_ID_ FROM ACT_HI_PROCINST WHERE
        ACT_HI_PROCINST.PROC_INST_ID_ = task.PROC_INST_ID_ ))
        )))
        <if test="filters.processName != null">
            AND flow_definition.name LIKE '%${filters.processName}%'
        </if>
        <if test="filters.nodeName != null">
            AND task.NAME_ LIKE '%${filters.nodeName}%'
        </if>
    </select>


</mapper>